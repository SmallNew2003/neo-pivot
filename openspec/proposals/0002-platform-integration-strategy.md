# 0002：多平台适配方案提案（Coze / Dify / n8n）

## 背景与问题陈述

当前 MVP 规格（`openspec/specs/0001-mvp-rag-knowledge-nexus-spec.md`）已经明确“核心底座”采用 Java 21 + Spring Boot + Modulith + PostgreSQL + PGVector，并在 AI Provider 与文件存储层面采用可插拔设计。

为进一步提升“架构全局观”和“场景适配能力”，希望在保持原生底座技术深度的前提下，同时支持多种上层平台方案：

- Coze：快速多端落地与应用交付
- Dify：更强的 RAG/Agent/运维能力（偏 AI 应用全生命周期）
- n8n：跨系统流程自动化与集成编排

问题在于：如果“所有平台都深度集成并同时完成闭环”，MVP 容易失控；但如果绑定单一平台，又会降低扩展性与选型能力展示。

本提案用于统一：平台适配目标、分层边界、集成方式与分阶段交付策略。

## 目标（Goals）

- 支持“多平台可选”的总体架构：核心底座能力不绑定平台，上层平台以适配方式接入。
- 明确并固化“核心底座”对外能力边界（标准化 API + 事件/Webhook），平台仅作为上层交互/编排/运营组件。
- 在不扩大 MVP 实现范围的前提下，保证后续接入 Dify/n8n 的成本可控（设计先行）。

## 范围界定：哪些进入 MVP，哪些后置

为避免误解：本提案旨在“定边界与定路线”，不是把 Coze/Dify/n8n 全部纳入 MVP 实现范围。

### MVP 范围（P1 必做）

- 核心底座能力闭环可用（上传/索引/检索/问答/权限/存储/可观测性）。
- 默认平台入口仅落地 1 个（当前默认：Coze）。
- 为 Dify/n8n 预留扩展位：接口语义、事件/Webhook 方向、适配层边界（设计到位即可）。

### 增强范围（P2/P3 后置）

- Dify 的实际接入（workflow/应用配置、鉴权对接、调用链路）作为增强项。
- n8n 的实际接入（工作流模板、webhook 订阅与重试、跨系统集成示例）作为增强项。

## 非目标（Non-Goals）

- 不承诺在 MVP 阶段完成 Coze/Dify/n8n 三者都可“一键部署、完整演示”的落地。
- 不在 MVP 阶段把“文档解析/分块/向量化/检索”同时在底座与 Dify 内双份实现（避免重复系统）。
- 不在本提案阶段确定每个平台的具体安装、网络、证书与运维细节（将以后续 specs/decisions 补齐）。

## 方案概述：核心底座 + 适配层 + 平台可选

### 分层与边界

1. 核心底座（Java 原生）
   - 负责：认证鉴权（JWT RS256）、文档元数据、对象存储（S3）、向量库（PGVector）、检索权限过滤、索引状态机、关键审计与可观测性。
   - 对外输出：标准化 REST API + 领域事件（内部）+ 可选 Webhook（外部）。
2. 适配层（Platform Adapters）
   - 负责：把不同平台的调用方式/鉴权/回调差异“吸收掉”，转换为对核心底座 API 的调用，或把底座事件转换为平台可消费的事件。
   - 约束：适配层不得反向侵入核心业务模型，避免平台锁定。
3. 上层平台（Coze/Dify/n8n）
   - 负责：对话体验、工作流编排、会话运营、跨系统集成、UI 与运营工具。
   - 不承担：底座层“数据一致性、权限隔离、索引与存储的真相来源（source of truth）”。

### 三个平台的推荐接入方式（建议）

- Coze
  - 角色：默认 Chat 应用层（对话入口）。
  - 方式：通过适配层调用底座 `/api/chat` 获取最终答案与 citations；或底座作为 Coze 工具（tool）被调用。
- Dify
  - 角色：AI 应用生命周期管理与 Agent 编排层。
  - 方式（推荐）：Dify 仅做编排/会话运营，通过工具调用底座 `/api/chat` 获取最终答案与 citations；底座仍保持索引与权限过滤的权威性（模式A）。
  - 方式（不推荐用于 MVP）：让 Dify 自己做完整 RAG 流水线，会与底座 `ai` 模块产生重复与职责混乱。
- n8n
  - 角色：流程自动化与跨系统集成编排层。
  - 方式：n8n 通过 HTTP 节点调用底座 API（上传、查状态、触发重试、订阅 webhook），实现“文档→索引→告警/工单/推送”的自动化。

## 交付策略（Phased Delivery）

### P0：设计落地（本提案）

- 明确边界与职责，定义“平台适配不侵入核心”的约束。
- 产出决定记录（decision）与后续规格拆分计划。

### P1：MVP 主路径（实现时）

- 选择 1 个平台作为默认演示入口（当前已决定：Coze）。
- 其他平台保留扩展位：在配置、接口与数据模型上不做“锁死”。
 - 非绑定约定：Coze 仅是默认入口，后续可按场景替换为 Dify/n8n 或自研前端，不应要求重构核心底座。

### P2：Dify 接入（增强）

- 以“检索工具 API + 会话运营”方式接入，避免双份 RAG 实现。
- 输出一份可复现的 Dify workflow 配置与调用说明（文档化即可）。

### P3：n8n 接入（增强）

- 提供 webhook 订阅与典型工作流示例（索引失败告警、定时同步、跨系统推送）。

## 验收标准（Acceptance Criteria）

- 核心底座 API 不因切换平台而变更语义（平台只是不同的“客户端/编排器”）。
- 可在不修改核心业务代码的前提下新增一个平台适配（仅新增 adapter 与配置）。
- Dify/n8n 接入路径在文档上可复现（哪怕实现阶段先不全部落地）。

## 风险与对策

- 范围膨胀风险：通过“主路径只落地一个平台 + 其余平台先设计后实现”控制。
- 职责重叠风险：明确“索引与权限过滤的权威来源”为核心底座；平台不重复做底座逻辑。
- 运维复杂度风险：S3 + PGVector + 平台自托管会增加依赖；通过分阶段与可选组件控制。

## 开放问题（Open Questions）

- Dify：是否自托管？是否要求数据不出网？与底座的鉴权如何对接（JWT 透传/服务间凭证）？
- Coze：平台侧工具调用（HTTP）能力、鉴权方式、超时/重试/并发限制、以及对结构化返回（citations）的承载能力如何？
- n8n：需要哪些标准 webhook 事件（索引成功/失败/重试）？是否需要幂等签名与重放保护？
- LLM Provider：模式 A 下底座作为最终生成方，默认落地 Provider 与模型版本需要单独决策与配置管理。
