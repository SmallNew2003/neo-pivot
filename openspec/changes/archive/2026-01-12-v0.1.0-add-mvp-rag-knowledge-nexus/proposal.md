# 0001：企业级 RAG 知识库系统 MVP 提案（认知知识枢纽）

## 背景与问题陈述

本仓库当前包含一份方向性文档 `docs/ai-assisted-1month-open-source-project.md`（作为早期背景材料），提出了一个企业级 RAG（检索增强生成）知识库系统的开源项目构想：基于 Java 21、Spring Boot 3、Spring AI，并强调模块化单体、最终一致性、向量检索权限控制等“高密度工程能力”。

为确保 1 个月开发周期内可以交付一个可演示闭环、可持续扩展且可被用户/贡献者快速理解的项目，需要先收敛为 MVP（最小可行产品）提案，统一目标、边界、里程碑与验收标准，再推进代码落地。

## 目标（Goals）

- 在 1 个月内交付一个可演示的 RAG 知识库闭环：上传文档 → 解析/分块 → 向量化入库 → 相似度检索 → 基于上下文问答。
- 采用模块化单体（Modular Monolith）组织代码，模块边界清晰，可讲清设计权衡与演进路径。
- 体现关键工程点：异步处理与最终一致性、可观测性基础、最小权限访问（MVP 级别）。
- 为后续迭代（权限细化、Outbox、对象存储、模型切换、评测体系）留出清晰扩展位。

## 非目标（Non-Goals）

- MVP 阶段不做多租户（Tenant）隔离与复杂计费体系。
- MVP 阶段不做完整的企业级 RBAC 细粒度到段落/向量级的权限过滤（仅实现最小可用的用户级或角色级过滤）。
- MVP 阶段不做分布式部署与微服务拆分（保持单体部署，逻辑模块化）。
- MVP 阶段不追求支持所有文档格式与极致解析效果（优先 PDF/Markdown/纯文本）。

## 范围（Scope）

### MVP 必做功能

1. 文档管理
   - 上传文件（至少支持 `pdf`/`md`/`txt` 任一组合）。
   - 记录元数据：文件名、大小、哈希、上传时间、状态（已上传/处理中/已索引/失败）。
2. 异步索引流水线
   - 文档解析（提取文本）→ 分块（chunk）→ 生成 embedding → 写入向量库。
   - 失败可回填状态与错误信息，便于演示与排障。
3. 检索与问答
   - 输入问题 → 生成 query embedding → 相似度检索 Top-K chunk → 组装上下文 → 调用 LLM 输出答案。
4. 最小权限控制（MVP 级）
   - 至少做到“用户只能检索到自己上传的文档的 chunk”（或“角色级”二选一）。
5. 可观测性（MVP 级）
   - 关键链路日志：上传、索引、检索、问答。
   - 关键指标或 tracing 视情况引入（可在下一阶段加强）。

### MVP 交付物

- 一套可运行的后端服务（Java 21 + Spring Boot 3）。
- 一份可演示脚本（或 Postman/HTTPie 示例）：上传 → 等待索引完成 → 提问。
- 文档：架构图（可用文字版/mermaid）、模块说明、关键设计点说明。

## 架构概述

### 模块划分（建议）

- `auth`：认证与用户上下文（MVP 可先用简化实现，例如固定用户/简单 JWT；具体方案在规格中定）。
- `document`：上传、存储、元数据、状态机。
- `ai`：ETL（解析/分块/向量化）、模型调用封装。
- `search`：相似度检索与问答编排。

### 事件流（建议）

- 文档上传成功后发布 `DocumentUploadedEvent(documentId)`。
- `ai` 模块监听事件，异步执行索引流水线，完成后回写文档状态。

### 数据存储（建议）

MVP 倾向采用“单数据库 + 向量扩展”的方式降低复杂度：

- 关系数据：PostgreSQL（或先用 H2 便于本地演示，后续切 PG）。
- 向量数据：PGVector（与 PostgreSQL 同库或同集群）。

> 具体选型与依赖版本在规格（spec）中最终敲定。

## 里程碑（Milestones）

- M1：项目骨架与模块边界确定；完成上传与元数据入库。
- M2：异步索引流水线可跑通；文档状态机可观测。
- M3：检索 + 问答闭环完成；提供可演示脚本。
- M4：补齐最小权限过滤；补齐关键文档与架构说明。

## 风险与对策

- 模型与向量库依赖复杂：MVP 优先选择 Spring AI + PGVector 的最短路径，避免同时引入过多外部组件。
- 文档解析质量不稳定：MVP 支持少量格式，先确保链路闭环与可观测性。
- 1 个月周期紧：先保证“可演示闭环”，把“企业级增强点”（Outbox、评测、RBAC 向量级、对象存储）放入后续提案。

## 验收标准（Acceptance Criteria）

- 能通过一条命令/一组 HTTP 请求完成：上传文档 → 等待索引完成 → 提问并得到引用上下文的回答。
- 索引失败时可在元数据中看到失败原因，且不会导致系统不可用。
- 用户 A 无法检索到用户 B 的文档片段（MVP 级别隔离）。
- 文档与代码结构能清晰映射到模块边界，便于长期维护与社区协作。

## 开放问题（Open Questions）

- 认证方式：MVP 采用 JWT（已确认），并采用 RS256（已确认）；JWKS 与本地开发签发方式在实现前补齐。
- 数据库：MVP 采用 PostgreSQL + PGVector（已确认），本地安装与初始化方式在实现前补齐。
- 异步执行：使用 Spring 事件 + 虚拟线程，还是引入消息队列？MVP 不引入 MQ，后续再评估。
- LLM/Embedding Provider：设计上支持 OpenAI/Azure OpenAI/Ollama 可插拔（已确认）；默认落地已决定采用 OpenAI Compatible API（见 `openspec/decisions/0009-llm-default-openai.md`），模型名称与参数在实现前补齐。
- 文件存储：设计上支持本地文件系统与 S3/MinIO 可插拔（已确认），且默认落地选择 S3（已确认）；但本地/CI 使用 AWS 还是 MinIO 的初始化方式在实现前补齐。
- 多平台适配：是否需要在实现阶段同步落地 Dify/n8n 的最小接入？总体策略见 `openspec/changes/archive/2026-01-12-v0.1.0-add-platform-integration-strategy/proposal.md`。
  - 说明：多平台的“设计与扩展位”可以进入 MVP；Dify/n8n 的“实际接入实现”默认后置到增强阶段。
