# 0003：平台接入鉴权与用户身份映射方案提案（Coze/Dify/n8n）

## 背景与问题陈述

当前架构采用“核心底座 + 适配层 + 多平台可选”，且主路径采用模式 A：最终答案生成由核心底座负责（`/api/chat` 输出答案与 citations）。

因此平台接入时必须解决两个问题：

1. **鉴权**：平台调用底座 API 时如何被授权（防止任意外部调用）。
2. **用户身份映射**：底座如何识别“这次请求代表哪个用户”，从而正确执行 `owner_id == userId(sub)` 的权限过滤。

如果不明确这两点，系统会出现：

- 权限隔离无法保证（平台侧用户可能“串号”或越权）
- 审计与问题排查困难（无法追溯到真实用户）
- 平台可替换性被破坏（每个平台各做一套 ad-hoc 逻辑）

本提案用于在实现前确定一条 MVP 主路径，并定义后续可演进方向。

## 目标（Goals）

- 明确并固化：平台接入底座的鉴权方式与用户身份映射方式。
- 与 JWT RS256（资源服务验签）方案一致，避免临时“后门”污染核心模型。
- 保持平台中立：Coze/Dify/n8n 的差异应当停留在适配层。

## 非目标（Non-Goals）

- 不在本提案阶段落地完整的企业 IdP（Keycloak/Azure AD）集成。
- 不在本提案阶段设计多租户（Tenant）全量体系（后续可扩展）。

## 方案选项

### 方案 A：平台透传终端用户 JWT（推荐：企业化、权限最清晰）

流程：

1. 终端用户在底座侧完成登录/换取 JWT（或由企业 IdP 统一签发）。
2. 平台（Coze/Dify）调用底座时携带用户 JWT：`Authorization: Bearer <user_jwt>`。
3. 底座以 `sub` 解析出内部用户 ID（`userId`），映射为 `owner_id`，执行权限过滤与审计（见 `openspec/decisions/0017-primary-key-strategy.md`）。

优点：

- 权限最清晰：每个请求天然绑定到用户身份。
- 审计闭环强：可追踪到具体用户。
- 平台无感：平台只是转发 token，不需要理解权限规则。

代价：

- 平台需要支持“携带/透传用户 token”或在 tool 调用中附带 header。
- 若平台只提供“平台侧统一 token”，则此方案难落地。

### 方案 B：平台使用服务 JWT + 显式用户标识（折中：实现快但需严格约束）

流程：

1. 平台以服务身份携带 `service_jwt` 调用底座（服务级鉴权）。
2. 请求体显式包含 `endUserId`（或 `endUserExternalId`）。
3. 底座仅在满足约束时接受该字段，并据此执行权限过滤。

必须的安全约束：

- `service_jwt` 必须区分平台来源与权限范围（例如只允许某些 API）。
- `endUserId` 必须可校验来源可信（例如与平台侧用户会话绑定，或由适配层做映射表）。
- 必须有审计字段：记录平台来源、service id、endUserId。

优点：

- 对平台能力要求更低：不必透传用户 JWT。
- 便于做“平台统一入口”快速落地。

风险：

- 一旦适配层或调用方处理不当，易产生越权风险。

### 方案 C：底座签发“委托 token”（Token Exchange，最正规但实现量更大）

流程：

1. 平台携带 `service_jwt` 调用底座的“token exchange”接口，携带平台用户身份信息。
2. 底座校验后签发短期 `delegation_jwt`（绑定 endUserId、aud、scope）。
3. 平台后续调用 `/api/chat` 使用 `delegation_jwt`。

优点：

- 兼顾安全与平台能力差异：平台不需要拿到用户登录 token。
- 可做细粒度 scope（只允许调用 chat/search 等）。

代价：

- 需要额外实现 token exchange 机制与密钥管理。

## 推荐与里程碑

结论与里程碑（先定主路径，再留演进）：

1. **MVP 主路径选择方案 A**：平台透传终端用户 JWT，底座以 `sub` 解析内部用户 ID 执行权限过滤与审计。
2. 若在某个平台上确实无法做到“用户级 token 透传”，则该平台接入改走方案 B（服务 JWT + 显式用户标识），并把安全约束与审计要求固化到 spec。
3. 中长期演进：引入方案 C（token exchange），作为“平台能力受限但仍需强安全”的企业化形态。

## 验收标准（Acceptance Criteria）

- 平台接入调用底座时，底座能稳定识别终端用户身份并执行权限过滤（owner 隔离）。
- 审计日志能回答：谁（JWT `sub` / userId）通过哪个平台入口在什么时间访问了哪个文档/片段。
- 接入方式平台中立：更换平台时不改核心 API 语义。

## 开放问题（Open Questions）

- Coze/Dify 的 tool 调用是否支持“按用户维度”注入请求头（尤其是 `Authorization`）？
- 用户 JWT 的获取与生命周期如何处理（登录、过期、刷新、撤销）？平台侧是否只保存短期 token？
- JWT `sub` 采用“内部用户 ID”（见 `openspec/decisions/0017-primary-key-strategy.md`）；若未来需要兼容外部平台用户 ID，则引入映射表与迁移策略作为后置增强。
